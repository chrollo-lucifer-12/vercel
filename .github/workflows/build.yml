name: Build Project

on:
  workflow_dispatch:
    inputs:
      gitURL:
        required: true
      projectSlug:
        required: true
      apiURL:
        required: true
      apiKey:
        required: true
      bucketId:
        required: true
      redisURL:
        required: true
      deploymentId:
        required: true
      userEnv:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install Redis CLI
        run: sudo apt-get install -y redis-tools

      - name: Run container and stream logs
        run: |
          publish() {
                redis-cli -u "${{ github.event.inputs.redisURL }}" \
                  XADD logs_stream * \
                    level "INFO" \
                    message "$1" \
                    created_at "$(date '+%Y-%m-%d %H:%M:%S')" \
                    deployment_id "${{ github.event.inputs.deploymentId }}"
          }

          publish "ðŸš€ Starting build container..."

          docker run --rm \
            -e USER_ENV="${{ github.event.inputs.userEnv }}" \
            -e DEPLOYMENT_ID="${{ github.event.inputs.deploymentId }}" \
            -e REDIS_URL="${{ github.event.inputs.redisURL }}" \
            -e SLUG="${{ github.event.inputs.projectSlug }}" \
            -e GIT_REPOSITORY_URL="${{ github.event.inputs.gitURL }}" \
            -e API_URL="${{ github.event.inputs.apiURL }}" \
            -e API_KEY="${{ github.event.inputs.apiKey }}" \
            -e BUCKET_ID="${{ github.event.inputs.bucketId }}" \
            sahil1107/builder-server:latest \
            2>&1 | while IFS= read -r line; do
              publish "$line"
            done

          publish "âœ… Build container finished"
